<!-- CABECERA -->
<header>
  <h1>ZavalaTech Parking</h1>
  <nav>
    <a routerLink="/inicio" routerLinkActive="active-link">Inicio</a>
    <a routerLink="/historial" routerLinkActive="active-link">Historial</a>
    <a routerLink="/estadisticas" routerLinkActive="active-link">EstadÃ­sticas</a>
    <button class="btn-admin" (click)="goToLogin()">
      {{ usuarioAutenticado ? 'ğŸš— Panel Admin' : 'ğŸ” Acceso Admin' }}
    </button>
  </nav>
</header>

<main>
  
  <!-- ESTADO DE CARGA -->
  <div *ngIf="cargando" class="loading">
    <div class="loading-spinner"></div>
    <p>Cargando historial...</p>
  </div>

  <!-- ERROR -->
  <div *ngIf="error && !cargando" class="error">
    <p>âš ï¸ {{ error }}</p>
    <button class="btn-filter" (click)="cargarVehiculosDesdeFirebase()">ğŸ”„ Reintentar</button>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <ng-container *ngIf="!cargando && !error">
    <!-- ENCABEZADO -->
    <div class="header-section">
      <h2>ğŸ“Š Historial de VehÃ­culos</h2>
      <p class="subtitle">
        Consulta el registro completo de todos los vehÃ­culos que han utilizado el estacionamiento.
        Incluye informaciÃ³n detallada de entradas, salidas y tiempos de permanencia.
      </p>

      <!-- ESTADÃSTICAS RÃPIDAS -->
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-label">Total de Registros</span>
          <span class="stat-value">{{ totalRegistros }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">VehÃ­culos Hoy</span>
          <span class="stat-value">{{ registrosHoy }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Tiempo Promedio</span>
          <span class="stat-value">{{ tiempoPromedio }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Tipo MÃ¡s ComÃºn</span>
          <span class="stat-value">{{ tipoComun }}</span>
        </div>
      </div>
    </div>

    <!-- FILTROS -->
    <div class="filters-section">
      <div class="filters-grid">
        <div class="filter-group">
          <label for="filtroPlaca">ğŸ” Buscar por Placa</label>
          <input 
            type="text" 
            id="filtroPlaca" 
            placeholder="Ej: ABC-123"
            [(ngModel)]="filtroPlaca"
            (input)="actualizarTabla()">
        </div>
        <div class="filter-group">
          <label for="filtroPropietario">ğŸ‘¤ Buscar por Propietario</label>
          <input 
            type="text" 
            id="filtroPropietario" 
            placeholder="Ej: Juan PÃ©rez"
            [(ngModel)]="filtroPropietario"
            (input)="actualizarTabla()">
        </div>
        <div class="filter-group">
          <label for="filtroTipo">ğŸš— Tipo de VehÃ­culo</label>
          <select 
            id="filtroTipo"
            [(ngModel)]="filtroTipo"
            (change)="actualizarTabla()">
            <option value="">Todos los tipos</option>
            <option value="Auto">Auto ğŸš—</option>
            <option value="Moto">Moto ğŸï¸</option>
            <option value="Camioneta">Camioneta ğŸš™</option>
            <option value="SUV">SUV ğŸš™</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filtroFecha">ğŸ“… Fecha</label>
          <input 
            type="date" 
            id="filtroFecha"
            [(ngModel)]="filtroFecha"
            (change)="actualizarTabla()">
        </div>
      </div>
    </div>

    <!-- TABLA DE HISTORIAL -->
    <div class="table-section">
      <div class="table-header">
        <h3>ğŸ“‹ Registros Completos ({{ vehiculosFiltrados.length }})</h3>
        <button class="export-btn" (click)="exportarCSV()" [disabled]="vehiculos.length === 0">
          ğŸ“¥ Exportar CSV
        </button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Espacio</th>
              <th>Placa</th>
              <th>Propietario</th>
              <th>Tipo</th>
              <th>Fecha</th>
              <th>Hora Entrada</th>
              <th>Hora Salida</th>
              <th>Tiempo Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="vehiculosFiltrados.length === 0">
              <td colspan="8" class="empty-state">
                <div class="empty-state-icon">ğŸ”</div>
                <div *ngIf="totalRegistros === 0">
                  No hay registros en el sistema aÃºn.
                </div>
                <div *ngIf="totalRegistros > 0">
                  No se encontraron registros que coincidan con los filtros.
                </div>
              </td>
            </tr>
            <tr *ngFor="let vehiculo of vehiculosFiltrados">
              <td>
                <span class="espacio-badge" *ngIf="vehiculo.espacioNumero">
                  ğŸ…¿ï¸ E-{{ vehiculo.espacioNumero < 10 ? '0' + vehiculo.espacioNumero : vehiculo.espacioNumero }}
                </span>
                <span *ngIf="!vehiculo.espacioNumero" style="color: #64748b;">-</span>
              </td>
              <td>
                <span class="placa-badge">{{ vehiculo.placa }}</span>
              </td>
              <td>{{ vehiculo.propietario }}</td>
              <td>{{ vehiculo.tipo }}</td>
              <td>{{ obtenerFecha(vehiculo.horaEntrada) | date:'dd/MM/yyyy' }}</td>
              <td>{{ obtenerFecha(vehiculo.horaEntrada) | date:'shortTime' }}</td>
              <td>
                <span *ngIf="vehiculo.horaSalida">
                  {{ obtenerFecha(vehiculo.horaSalida) | date:'shortTime' }}
                </span>
                <span *ngIf="!vehiculo.horaSalida" style="color: #64748b;">
                  En estacionamiento
                </span>
              </td>
              <td style="font-weight: 600;">
                {{ calcularTiempo(vehiculo.horaEntrada, vehiculo.horaSalida) }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </ng-container>
</main>

<!-- PIE DE PÃGINA -->
<footer>
  Â© 2025 <strong>ZavalaTech</strong> | Sistema de GestiÃ³n de Estacionamiento | Todos los derechos reservados
</footer>